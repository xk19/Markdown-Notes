## 用于介入手术导管的空间形状重构方法

## 一、论文思路

1. （改进的）U-Net网络对导管形状进行分割，先进行标注，进行训练，得到好的分割效果
2. 双平面透视系统标定，利用对极几何求解旋转和平移矩阵（待做）
3. 将空间曲线重构问题转换成直纹曲面相交问题，编写算法，求解曲线三维形状（待做）

## 二、论文结构

### 摘要

介入手术是治疗心血管疾病的主要方式之一，术中需要通过手动向目标血管中放置一根导管来进行手术。为了提升手术效率和减少辐射暴露，提出了一种介入手术导管空间形状重构方法。本文中，我们提出使用语义分割算法来从二维荧光透视图像中提取出导管轮廓，使用骨架化算法从分割的导管轮廓中提取出导管的中心线，并通过三次B样条拟合来描述导管轮廓的中心线。随后，我们提出了一种新方法，根据对极几何关系求解出投影平面中导管中心线的对应点，利用相机系统与双平面中的导管中心线构造空间射线，通过将空间曲线重构问题转化射线的相交问题，最终迭代求解出空间相交点，并拟合重构出导管的三维空间形状。最后，通过3D打印导管模型进行测试和评估，验证该方法的稳定性和可靠性。

### Introduction

> 这一部分首先由心血管疾病引出介入手术，并对介入手术进行介绍，然后概述目前介入手术治疗的现状，并引出存在的问题，缺乏三维深度信息，无法实现术中导管三维可视化。然后介绍一些目前三维可视化的现状，存在使用双平面透视进行指导的情况。最后说明本文工作，针对这些问题，本文提出什么使用什么学习算法从造影图像中提取导管的形状，然后提出了一种空间曲线重构算法，利用两个视角的造影图像重建出导管的空间形状。通过实验验证，怎么了我们的方法可行。然后列出本文主要贡献。

随着现代社会生活节奏的加快和人口老龄化的加剧，心血管疾病成为了一种严重威胁人类健康的常见疾病，其发病率和死亡率都相对较高，已经是威胁人类健康的“头号杀手”。

在众多治疗心血管疾病的方法中，介入手术以其独特的优势，如创伤小、恢复快等，成为主要的治疗手段之一。手术过程中医生需要根据造影图像和经验将介入手术导管手动的推送至病灶处。一旦到达病灶，就可以放置药物、球囊或者支架等进行治疗。然而在导丝输送过程中，由于缺乏导管深度信息、无法实现术中导管的三维可视化等问题，导致导管的输送性和到位准确率低，介入手术导管推送时间长，患者和临床医生长时间暴露于射线辐射中。

为实现术中导管三维形状可视化，许多方法已经被应用于术中导管形状重构，如光纤光栅传感、电磁融合等，但是这些方法往往存在较大的形状传感误差，且很难在不增加导管粗细的情况下完成传感器集成。为了解决这些问题，本文提出了了一种介入手术导管空间形状重构方法，我们通过深度学习算法来从造影图像中准确的提取出导管的形状，然后提出一种重建曲线重构算法，利用两个不同角度的造影图像提取出的导管平面形状，通过曲线重构算法重建出导管的三维形状。我们的贡献主要如下：

- 提出基于U-Net网络对双平面透视图像中的导管形状进行分割，并在构建的数据集上进行训练和验证
- 提出了一种空间曲线重构算法，将空间曲线重构问题转换成曲面与一组射线相交的问题，求解曲线三维形状
- 利用3D打印的模型进行实验验证，方法重建的形状有较好的结果

### Related Work

1. 造影图像中提取二维导管的形状

   > 概述目前造影图像中提取二维导管形状的研究现状，包括传统数字图像处理算法和深度学习算法，最后说明本文使用的U-Net网络提取的优点。

   在造影图像中提取二维导管形状的研究是医疗图像处理领域的一个重要课题，对于诊断心血管等疾病具有重要意义。主要处理方法有传统数字图像处理算法和深度学习算法。

   传统数字图像处理方法在提取导管形状时，首先需要进行滤波算法去除图像中的噪声和伪影，提高图像质量，然后通过边缘检测、阈值分割、形态学操作和区域生长等步骤完成对导管分割。但是传统算法依赖于手工设计的特征和规则，虽然具有较低的复杂度和较快的运行速度，但是往往只能针对特定的图像进行提取，泛化性能较差。

   随着深度学习技术的不断发展，越来越多的研究者开始将其应用于造影图像中二维导管形状的提取。深度学习算法具有强大的特征学习和表示能力，能够自动从大量数据中学习到有效的特征表示。其中U-Net网络因其采用了编码器-解码器（Encoder-Decoder）结构，这种结构能够很好地捕捉图像中的上下文信息，能够同时兼顾图像的局部细节和整体结构，因此非常适合医疗影像分割任务。目前已有较多一些U-Net网络处理医疗影像的，但主要用于视网膜血管分割、肿瘤分割、多器官腹部分割等任务，尚未有用于介入手术导管的分割工作。由于深度学习算法则能够自动从数据中学习到有效的特征表示，具有更强的泛化能力和准确性，因此可以在导管的分割任务上展现出很好的效果。

2. 空间曲线重构

   > 概述目前空间曲线重构算法的发展，然后说明本文提出的算法的优点。
   
   空间曲线重构算法在近年来取得了显著的进步，特别是在医疗诊断和机器人导航等关键领域。该算法主要通过对物体的空间线形结构进行深入分析和精确计算，以实现对物体三维形状的准确重构。目前，空间曲线重构算法已经涵盖了多种方法，包括曲线拟合、曲面重建和点云重建等。在曲线拟合中，常使用最小二乘法、贝叶斯估计等先进算法；而在曲面重建方面，Bezier曲面、NURBS曲面以及三角剖分等技术均被广泛应用。在机器人导航领域，空间曲线重构算法与传感器技术的结合，为机器人提供了更加精确的环境感知和定位能力，有效提升了其自主导航和路径规划的准确性；而在医疗领域，空间曲线重构算法与医学影像处理技术的结合，为医生提供了更为准确、直观的病灶信息，助力疾病诊断和治疗。
   
   在过去也存在一些对曲线重建的方法，如基于点的方法，该方法在处理复杂或动态变化的形状时更加灵活，但是往往需要根据特征点来进行匹配，实际情况中点的对应关系可能并不清楚或者很难建立。此外也有基于曲线的重建方法，但是主要针对特定类型的曲线或具有特定结构的曲线，如椭圆曲线、二次曲线等，并不具有一般性。
   
   在比较新的工作中，Yijun Zhou等人提出了一种基于曲面相交的算法，该算法可以通过求解二次曲面的空间相交问题来实现三维曲线的重建，但是该算法的迭代过程复杂，具有较大的运算大，不适合介入手术导管形状的术中重建。本文提出了一种新的曲线重构算法，通过对极几何关系计算出双平面中的对应点集，然后利用双平面的对应点集和相机中心构造空间射线，通过求解射线的相交来得到曲线的空间相交点，使迭代过程更加精简化，并准确重构出导管形状。

### U-Net网络提取导管形状

传统的数字图像算法在提取造影图像中的导管形状时，往往局限于特定的对象，缺乏泛化能力。这意味着，一旦目标病人或病变位置发生变化，现有的导管提取算法可能不再适用，导致算法的准确性和可靠性无法得到保障。为了解决这个问题，我们提出基于U-Net网络分割导管形状，以应对不同病人和病变情况下的导管形状提取任务。

1. U-Net网络结构

   > 说明U-Net网络在医学图像上表现优越，概述U-Net网络结构，并附图进行说明

   U-Net网络结构由主干特征提取部分和加强特征提取部分组成。主干特征提取部分为卷积块和池化层的堆叠，每个卷积块包括卷积层（通常是3x3卷积核）、批量归一化（Batch Normalization）和激活函数（通常是ReLU），利用主干特征提取部分我们可以获得五个初步有效特征层；U-Net网络的特殊之处在于加强特征提取部分，由反卷积块和上采样层组成，每个反卷积块包含反卷积层（也称为转置卷积）、批量归一化和激活函数，利用主干部分获取到的特征图进行上采样，并通过跳跃连接分别与五个初步有效特征层进行特征融合，获得一个最终的融合了所有特征的有效特征层。最后通过1 × 1卷积将加强特征提取网络的输出映射为最终的分割结果。

   U-Net的整体结构使其能够同时利用图像的低级和高级特征，从而在图像分割任务中表现出色。这种结构的设计也使得网络对于输入图像的不同尺寸具有一定的鲁棒性。

   ![image-20240719004300510](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240719004300510.png)

2. 数据集构建

   > 说明数据集如何采集，采用什么进行半自动标注

   本文使用的数据集通过相机系统进行模拟采集，相机型号为海康MV-CH120-10GC，采集图像参考造影图像，采用多种手术背景，数据清洗后共5823张带导管的灰度图像，使用半自动标注工具ISAT_with_segment_anything进行分割数据集标注。

3. 参数设置及评估指标

   为了评估U-Net网络在导管提取任务中的性能，将像素分为四类:真阳性（TP）、真阴性（TN）、假阳性（FP）和假阴性（FN），选择交并比(IOU)和像素准确率PA和作为评估指标。
   $$
   IOU=\dfrac{TP}{FP+TP+FN}
   $$

   $$
   PA=\dfrac{TP+TN}{TP+TN+FP+FN}
   $$

4. 轮廓提取效果评估

   > 如果算法有改进，这部分考虑和其他算法进行对比，没有改进则直接说明分割效果

   对5823张图像数据集进行训练和验证，数据集按照9：1的比例分割成训练集和验证集，其中训练集包含图片5241张，验证集包含图片584张。下图显示了U-Net网络训练和验证的损失函数，及对应拟合曲线。模型的IOU=95.8，PA=97.95。

   ![image-20240719105212219](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240719105212219.png)

   ![image-20240515103829460](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240515103829460.png)

   保留训练过程中的最优模型，并对选定的测试集图片进行语义分割，测试集图像及结果如下图

   ![image-20240719005011895](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240719005011895.png)

   ![image-20240719005048974](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240719005048974.png)

   利用U-Net网络对介入手术导管分割能够保持相当高的精准度，且该模型能够识别各种手术场景下造影图像中的导管，具备较好的泛化能力，无需针对特定病人或者手术部位单独编写程序。

   介入手术导管形状提取在医学领域具有重要意义。它不仅为医生提供了导管在体内的形状信息，使得医生能够更直观地了解导管的形态和位置，同时也有利于计算机进行进一步的处理和分析，如精确地计算导管与血管的相对位置，或者对导管形状进行三维重构，从而构建出更加真实的手术模拟场景。这些详细的信息和分析结果对于手术模拟、效果预测、个性化治疗方案的制定以及远程医疗协作都具有重要的应用价值，同时有助于提高医生的手术成功率。

   ### 空间曲线重构方法

   本节提出了一种空间曲线重构方法，首先基于上节的U-Net网络模型从平面造影图像中提取出导管形状，然后对导管形状骨架化处理，得到导管的中心线，将中心线进行采样，根据对极几何关系寻找对应点，再结合双平面相机系统，连接相机中心与各对应点形成射线，迭代求解射线相交点，得到导管空间形状点集，将空间点集拟合成曲线即得到导管空间形状。

   1. 相机坐标标定及骨架化 

      > 写空间曲线重构算法的准备工作，包括相机坐标系标定、骨架化得到中心线等

      如同其他重建方法一样，所提出的方法的首要步骤是获取2D图像，这些图像来源于安装在立体视觉系统中的相机。为了准确获取图像数据，我们可以利用许多成熟的摄像机标定技术，比如张标定法。

      接下来，通过第3节所训练的U-Net网络模型，我们能够精确地提取出导管轮廓。在得到准确分割的导管轮廓后，采用骨架化算法来进一步提取导管的中心线。具体而言，骨架化是将输入图像转换为二值图像的过程，即将图像中的导管部分设置为前景（通常为白色），而将背景部分设置为背景（通常为黑色）。随后，进行骨架化操作，这通常涉及通过腐蚀等形态学操作处理图像，并与原图像进行差分运算，最终得到仅包含导管中心线的骨架化图像。

      <img src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240619095749472.png" alt="image-20240619095749472" style="zoom:80%;" />

   2. 三维曲线重构基本原理

      > 将骨架化后的左边平面的中心线进行采样，得到左边平面上的一组点集，然后将点集通过对极几何关系对应求得右侧的对应极线，通过求取右边图像中骨架化的导管中心线与极线的相交点可以求得左边平面点集在右侧的对应右边点集，然后将两边的相机中心与两边投影面的点集分别连接得到两组射线，两组射线的交点即为导管的空间形状点集，将空间点集进行拟合得到导管空间形状。

      为了重构出导管的三维形状，本文采用三次B样条曲线对骨架化处理后的中心线进行描述，左右中心线的三次B样条描述分别为$C_l(s)$、$C_r(s)$，并对左边的曲线进行采样，采样后的点集为$C_l^*(s)$。左边的相机中心为$O_l$，右边的相机中心为$O_r$，由对极几何关系可知，在左侧相机平面确定一个点$P_l$的时候，右侧相机平面可确定一条对应直线$k(s)$。求解直线$k(s)$与右侧曲线$C_r(s)$的相交点，即可得到左边点$P_l$的右侧对应点$P_r$，以相机中心$O_l$、$O_r$分别向$P_l$、$P_r$作射线，射线相交点$P_0$即为$P_l$、$ P_r$​所对应的导管空间重构点。

      ![image-20240619101736022](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240619101736022.png)

      具体的，如下图所示，空间点$P_0$在左、右相机坐标系中对应的坐标为$p_l$、$p_r$，在左右图像坐标系中对应坐标为$\tilde{p_l}$、$\tilde{p_r}$​，则有
      $$
      \tilde{p_l}=\dfrac{1}{z_l}p_l
      $$

      $$
      \tilde{p_r}=\dfrac{1}{z_r}p_r
      $$

      ![image-20240718105506069](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240718105506069.png)

      $O_r$相对于$O_l$的旋转矩阵为$R$，平移矩阵为$T$，即
      $$
      O_r=R（O_l+T）
      $$
      

      由于双平面相机系统，同一点在双相机系统坐标系中的关系为
      $$
      p_r=R（p_l+T）
      $$
      将上面公式带入到该公式中，可得
      $$
      \tilde{p_r}=\dfrac{1}{z_r}(z_lR\tilde{p_l}+T)
      $$
      根据对极几何关系求解可知
      $$
      \tilde{p_r}^TE\tilde{p_l}=0
      $$
      上式即为对极几何的约束关系，其中$E$为本质矩阵，可由旋转矩阵和平移矩阵求得。根据该本质矩阵，可得到右侧投影平面的约束直线$k(s)$，联立直线$k(s)$与$p_r(s)$，可得点$p_r$

      <img src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240619100741213.png" alt="image-20240619100741213" style="zoom:50%;" />

      依次求解左边投影平面点集在右侧相机平面的对应点，即可得到两组一一对应的点集。结合相机中心的位置信息，可构建两组与相机中心相关联的空间射线，左边投影平面的点集为$C_l(s)$，将相机中心与投影平面的点集相连接可以得到射线$S_l(s,t)$；右投影平面的点集为$C_r(s)$；将相机中心与投影平面的点集相连接可以得到射线$S_r(s,t)$。由于射线$S_l(s,t)$与$S_r(s,t)$可以一一对应相交，即可求出空间点集$P(s,t)$，将空间点集进行拟合，即可得到导管的空间三维形状。

      <img src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240619100411603.png" alt="image-20240619100411603" style="zoom:50%;" />

   3. 空间曲线相交求解算法

      > 伪代码

### Experience and Results：导管三维形状重构

   1. 实验装置

      为了评估本文所提出的方法，依照事先设定好的数学函数3D打印4种不同形状的的导管模型，分别在实验室和医院的造影造影设备上进行了实验验证。

      采用的3D打印形状及曲线如下

      

      ![image-20240710114355102](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240710114355102.png)

      <img src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240719010543300.png" alt="image-20240719010543300" style="zoom:50%;" />

      3D打印管由如下预定义的数学函数制成：
      $$
      X_t=33*cos(2t)
      $$

      $$
      Y_t=33*sin(2t)
      $$

      $$
      Z_t=55t
      $$

      $$
      t\subset[0,0.5\pi]
      $$

      使用基于点的配准方法将该导管形状配准到相机空间中，并根据数学函数来提供地面真值。

      a）第一个实验在实验室，采用双平面相机系统模拟造影实验，相机系统由两套MV-CH250-90GC面阵相机及视觉支架组成，镜头采用MVL-KF1640-25MP，相机投影平面的水平夹角不限制。实验系统如下：

      <img src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240710110914321.png" alt="image-20240710110914321" style="zoom:67%;" />

      用于相机配准的装置如下

      ![image-20240710114444528](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240710114444528.png)

      首先对两个相机进行配准，采用以固定速率进行图像采集，并且通过语义分割算法分割出导管的形状，对其骨架化和采样，然后通过本文所述算法从欧股出空间形状。

      b）第二个实验在医院手术室场景进行，分别采集C形臂在正位和侧位30°的造影图像进行空间重构，用于测试该方法在造影设备上的效果，实验装置如下图：

      ![image-20240719011129153](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240719011129153.png)

   3. 评估方法

      通过以下评价指标对本文所提方法重建的形状与地面真实形状进行比较：

      - 重建形状和地面真实形状之间的最大距离误差，
      -  均方根误差

   3. 结果与讨论

      分别将两个导管形状进行形状重构，采用训练的U-Net网络模型进行平面导管形状提取，并采用所述的算法进行空间形状重构，结果如下图所示： 

      ![image-20240718094527595](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240718094527595.png)

      ![image-20240718100540975](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240718100540975.png)

      （第一列、第二列为实验室场景，第三列、第四列为手术室场景，上面第一行为导管真实形状与重构形状的对比图，配准到同一坐标系下；第二行、第三行为对应的两个双平面采集图像，第四行为各点重建形状和地面真实形状之间的最大距离误差）

       在实验室相机系统的实验中，需要对两个相机进行标定，而使用可旋转的C形臂进行实验时，由于在设备为固定坐标系，因此无需进行配准。由结果可知，在两种实验场景下，均可从存在干扰的图像中精准提取导管的轮廓，这是由于使用语义分割算法具有较好的泛化性。所提出的导管形状重建方法能过够以10Hz的下运行。在实验室场景下，本文所提出的算法重建导管形状的最大误差为amm，均方根误差为bmm，而在医院场景中重建的最大误差为cmm，均方根误差为dmm。这是因为由于实验室环境中由于双相机系统标定过程中存在误差，以及相机内部参数的影响，导致重构形状误差增大。而心血管介入手术临床医生能够接受的形状精度通常在5mm以内，满足临床医生的需求。

### Conclusion

 本文提出了一种新的介入手术导管空间形状重构方法，可通过双平面造影图像准确重构导管的三维形状。使用U-Net网络从造影图像中分割出平面导管形状，并进行中心化，能够准确得到导管在两个平面的投影中心线。提出了一种基于对极几何关系的空间形状重建方法，以准确重建出介入手术导管的三维形状。通过3D打印的导管形状对所提出的方法进行评估。在两种实验设置下，最大误差不足cmm，均方根误差不足dmm。该性能超过了作者所知的其他工作中的性能，可将该方法用于介入手术导管形状重建工作中，通过该方法，医生可以在手术过程中通过双平面造影系统得到准确的导管三维信息，精准指导医生进行手术操作，减少医生反复推送过程的时间，有效提升手术效率和安全性。



## 三、参考

- 介入手术及双平面透视

  > 论文 Reconstruction of coronary arteries from X-ray angiography: A review

- 语义分割

  > [U-Net网络 Bubbliiiing](https://blog.csdn.net/weixin_44791964/article/details/108866828)
  >
  > [大模型 Segment Anything](https://zhuanlan.zhihu.com/p/619962145)
  >
  > [数据标注软件 ISAT_with_segment_anything](https://github.com/yatengLG/ISAT_with_segment_anything)
  >
  > [数据标注软件 Anylabeling](https://github.com/vietanhdev/anylabeling)

- 对极几何

  > [Epipolar Geometry、PnP、ICP](https://zhuanlan.zhihu.com/p/538017402)
  >
  > [对极几何详解blog](https://www.cnblogs.com/houkai/p/6661607.html)   
  >
  > [对极几何详解CSDN](https://blog.csdn.net/wen_zhi/article/details/123759379)
  >
  > [对极几何B站视频](https://www.bilibili.com/video/BV13D4y157PU/?p=14&vd_source=13dcf7fb782925cf156eabe37fb05412)
  >
  > [计算机视觉 相机标定 多视觉立体成像(video+code)](https://cvfxbook.com/useful-code/)

- 配准

  > 

- 空间曲线重构

  > [直纹曲面（圆锥曲面）](https://baike.baidu.com/item/%E7%9B%B4%E7%BA%B9%E6%9B%B2%E9%9D%A2/22786650?fr=ge_ala)
  >
  > [锥面](https://baike.baidu.com/item/%E9%94%A5%E9%9D%A2/2034771?fr=ge_ala)
  >
  > [圆锥面方程描述](https://www.bilibili.com/video/BV18d4y1v7WP/?spm_id_from=333.788&vd_source=13dcf7fb782925cf156eabe37fb05412)


$$
(u,v,1)\left (
\begin{array}{ccc}
F_{11}&F_{12}&F_{13}\\
F_{21}&F_{22}&F_{23}\\
F_{31}&F_{32}&F_{33}
\end{array}
\right)(u,v,1)=0
$$

$$
\left (
\begin{array}{ccc}
F_{11}&F_{12}&F_{13}\\
F_{21}&F_{22}&F_{23}\\
F_{31}&F_{32}&F_{33}
\end{array}
\right)
$$
